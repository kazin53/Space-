<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Space Balloon Ultra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Adicionando Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      touch-action: manipulation;
      height: 100%;
    }
    
    canvas { 
      display: block; 
      cursor: pointer;
    }
    
    /* Telas do jogo */
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      color: white;
      text-align: center;
      padding: 20px;
      transition: all 0.5s ease;
    }
    
    /* Tela de início personalizada */
    #mainMenu {
      background: linear-gradient(135deg, #1a1a2e, #0f3460);
      z-index: 300;
    }
    
    /* Tela de início do jogo */
    #gameStart {
      background: linear-gradient(135deg, #1a1a2e, #0f3460);
      z-index: 200;
      display: none;
    }
    
    /* Tela de game over */
    #gameOverScreen {
      background: rgba(0, 0, 0, 0.9);
      z-index: 150;
      display: none;
    }
    
    /* Tela de pause */
    #pauseScreen {
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      display: none;
    }
    
    /* Tela de configurações */
    #settingsScreen {
      background: rgba(0, 0, 0, 0.95);
      z-index: 400;
      display: none;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 80px;
      overflow-y: auto;
    }
    
    h1 {
      font-size: clamp(2rem, 6vw, 4rem);
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    h2 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin: 20px 0;
      color: #4cc9f0;
    }
    
    p {
      font-size: clamp(1rem, 3vw, 1.2rem);
      margin: 10px 0;
      line-height: 1.5;
    }
    
    button {
      padding: 15px 30px;
      font-size: 1.2rem;
      background: linear-gradient(45deg, #4cc9f0, #4361ee);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      margin: 10px;
      font-weight: bold;
      min-width: 200px;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button.secondary {
      background: linear-gradient(45deg, #f72585, #b5179e);
    }
    
    button.small {
      padding: 8px 16px;
      font-size: 0.9rem;
      min-width: auto;
    }
    
    /* HUD do jogo */
    #hud {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 1.2rem;
      color: white;
      background: rgba(0,0,0,0.4);
      padding: 10px 15px;
      border-radius: 10px;
      z-index: 50;
      backdrop-filter: blur(5px);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    #pauseBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      font-size: 1rem;
      background: linear-gradient(45deg, #FF5722, #FF8A65);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 50;
    }
    
    #comboBar {
      position: absolute;
      top: 70px;
      left: 20px;
      width: 200px;
      height: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
      z-index: 50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    #comboFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ffdd00, #ff0080);
      transition: width 0.2s ease, background 0.3s ease;
    }
    
    #comboText {
      position: absolute;
      top: 70px;
      left: 230px;
      color: white;
      font-size: 1rem;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      z-index: 50;
    }
    
    #levelIndicator {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: white;
      font-size: 1rem;
      background: rgba(0,0,0,0.4);
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 50;
      backdrop-filter: blur(5px);
    }
    
    .instructions {
      max-width: 500px;
      margin: 20px auto;
      font-size: 1rem;
      line-height: 1.5;
      color: #a5b4fc;
    }
    
    .logo {
      font-size: 3rem;
      margin-bottom: 20px;
      color: #4cc9f0;
      text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
    }
    
    .settings-icon {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 1.5rem;
      color: white;
      cursor: pointer;
      z-index: 500;
      transition: transform 0.3s ease;
    }
    
    .settings-icon:hover {
      transform: rotate(30deg);
      color: #4cc9f0;
    }
    
    .external-link {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.5rem;
      color: white;
      cursor: pointer;
      z-index: 500;
    }
    
    .external-link:hover {
      color: #f72585;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 10px;
      cursor: pointer;
      border: 2px solid white;
      transition: transform 0.2s ease;
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.selected {
      border: 3px solid gold;
      box-shadow: 0 0 10px gold;
    }
    
    .settings-section {
      margin: 20px 0;
      width: 90%;
      max-width: 500px;
    }
    
    .color-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 15px 0;
    }
    
    /* Efeito de pontuação */
    .score-effect {
      position: absolute;
      color: #4cc9f0;
      font-size: 1.5rem;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255,255,255,0.8);
      z-index: 60;
      animation: floatUp 1s ease-out forwards;
    }
    
    @keyframes floatUp {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      100% {
        transform: translateY(-50px);
        opacity: 0;
      }
    }
    
    @media (max-width: 768px) {
      #hud {
        flex-direction: column;
        gap: 5px;
        font-size: 1rem;
      }
      
      #comboBar, #comboText {
        top: 120px;
      }
      
      #comboBar {
        width: 150px;
      }
      
      button {
        padding: 12px 24px;
        font-size: 1rem;
      }
      
      .settings-section {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Tela de Menu Principal -->
  <div id="mainMenu" class="screen">
    <i class="fas fa-cog settings-icon" id="settingsIcon"></i>
    <a href="https://kusuncod.github.io/CadzinB/" target="_blank" class="external-link">
      <i class="fas fa-external-link-alt"></i>
    </a>
    
    <div class="logo">
      <i class="fas fa-rocket"></i>
    </div>
    <h1>SPACE BALLOON ULTRA</h1>
    
    <div class="instructions">
      Estoure os balões antes que escapem!<br>
      Combine acertos rápidos para aumentar sua pontuação.<br>
      Desbloqueie novos níveis conforme progride!
    </div>
    
    <button id="playBtn">JOGAR</button>
    <button id="howToPlayBtn" class="secondary">COMO JOGAR</button>
    
    <div class="credits">
      Desenvolvido com <i class="fas fa-heart" style="color: #f72585;"></i> por você
    </div>
  </div>
  
  <!-- Tela de Como Jogar -->
  <div id="howToPlayScreen" class="screen" style="display: none; z-index: 350;">
    <h2>COMO JOGAR</h2>
    <div class="instructions">
      <p><i class="fas fa-mouse-pointer"></i> Clique nos balões para estourá-los</p>
      <p><i class="fas fa-bolt"></i> Acertos consecutivos aumentam seu combo</p>
      <p><i class="fas fa-heart"></i> Você perde uma vida quando um balão escapa</p>
      <p><i class="fas fa-trophy"></i> Alcance pontuações altas para desbloquear novos níveis</p>
    </div>
    <button id="backToMenuBtn" class="secondary">VOLTAR AO MENU</button>
  </div>
  
  <!-- Tela de Configurações -->
  <div id="settingsScreen" class="screen">
    <h2>CONFIGURAÇÕES</h2>
    
    <div class="settings-section">
      <h3>Cor dos Balões</h3>
      <div class="color-options" id="balloonColors">
        <div class="color-option selected" style="background: #000000;" data-color="#000000"></div>
        <div class="color-option" style="background: #0000FF;" data-color="#0000FF"></div>
        <div class="color-option" style="background: #FFFF00;" data-color="#FFFF00"></div>
        <div class="color-option" style="background: #FF0000;" data-color="#FF0000"></div>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>Cor de Fundo</h3>
      <div class="color-options" id="bgColors">
        <div class="color-option selected" style="background: #1a1a2e;" data-color="#1a1a2e"></div>
        <div class="color-option" style="background: #16213e;" data-color="#16213e"></div>
        <div class="color-option" style="background: #0f3460;" data-color="#0f3460"></div>
        <div class="color-option" style="background: #1f1d36;" data-color="#1f1d36"></div>
        <div class="color-option" style="background: #0d1b2a;" data-color="#0d1b2a"></div>
        <div class="color-option" style="background: #1b263b;" data-color="#1b263b"></div>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>Volume</h3>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
    </div>
    
    <button id="saveSettingsBtn">SALVAR CONFIGURAÇÕES</button>
    <button id="closeSettingsBtn" class="secondary">FECHAR</button>
  </div>
  
  <!-- Tela de Início do Jogo -->
  <div id="gameStart" class="screen">
    <h1>SPACE BALLOON ULTRA</h1>
    <div class="instructions">
      Clique nos balões para estourá-los e ganhar pontos!<br>
      Mantenha um combo clicando rápido nos balões.<br>
      Cuidado para não deixar os balões escaparem ou perderá vidas!
    </div>
    <button id="startBtn">INICIAR</button>
    <audio id="bgMusic" loop>
      <source src="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-668.mp3" type="audio/mpeg">
    </audio>
    <audio id="popSound">
      <source src="https://assets.mixkit.co/active/69/preview.mp3" type="audio/mpeg">
    </audio>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="hud">
    <div>Pontos: <span id="score">0</span></div>
    <div>Vidas: <span id="lives">5</span></div>
    <div>Recorde: <span id="highscore">0</span></div>
  </div>

  <div id="comboBar"><div id="comboFill"></div></div>
  <div id="comboText">Combo: 0</div>

  <div id="levelIndicator">Nível: Terra</div>

  <button id="pauseBtn">⏸️ Pausar</button>

  <div id="pauseScreen" class="screen">
    <h1>JOGO PAUSADO</h1>
    <button id="resumeBtn">Continuar</button>
    <button id="restartBtnPause" class="secondary">Reiniciar</button>
    <button id="quitBtn" class="secondary">Sair para o Menu</button>
  </div>

  <div id="gameOverScreen" class="screen">
    <h1>FIM DE JOGO</h1>
    <p id="finalScore">Pontuação: 0</p>
    <p id="finalLevel">Nível alcançado: Terra</p>
    <p id="newRecord" style="color: gold; display: none;">NOVO RECORDE!</p>
    <button id="restartBtn">Jogar Novamente</button>
    <button id="menuBtn" class="secondary">Menu Principal</button>
  </div>

<script>
// Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDmiMmuv7wyqrxOBbAj-XnVttMXDO3YSXk",
  authDomain: "avaliar-site-space.firebaseapp.com",
  databaseURL: "https://avaliar-site-space-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "avaliar-site-space",
  storageBucket: "avaliar-site-space.firebasestorage.app",
  messagingSenderId: "372901714998",
  appId: "1:372901714998:web:bfe5aa406285f6caa70c97",
  measurementId: "G-755T2KYH5R"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Configurações iniciais
const mainMenu = document.getElementById('mainMenu');
const howToPlayScreen = document.getElementById('howToPlayScreen');
const settingsScreen = document.getElementById('settingsScreen');
const gameStartScreen = document.getElementById('gameStart');
const gameOverScreen = document.getElementById('gameOverScreen');
const pauseScreen = document.getElementById('pauseScreen');
const playBtn = document.getElementById('playBtn');
const howToPlayBtn = document.getElementById('howToPlayBtn');
const backToMenuBtn = document.getElementById('backToMenuBtn');
const settingsIcon = document.getElementById('settingsIcon');
const startBtn = document.getElementById('startBtn');
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Elementos da interface
const scoreDisplay = document.getElementById('score');
const livesDisplay = document.getElementById('lives');
const highscoreDisplay = document.getElementById('highscore');
const comboText = document.getElementById('comboText');
const levelIndicator = document.getElementById('levelIndicator');
const finalScoreDisplay = document.getElementById('finalScore');
const finalLevelDisplay = document.getElementById('finalLevel');
const newRecordDisplay = document.getElementById('newRecord');
const volumeSlider = document.getElementById('volumeSlider');

// Variáveis do jogo
let balloons = [], meteors = [], lavaBubbles = [], waterBubbles = [], sandParticles = [];
let clouds = [], raindrops = [], comboParticles = [], stars = [], scoreEffects = [];
let score = 0, lives = 5, combo = 0, lastClickTime = 0;
let highscore = parseInt(localStorage.getItem('highscore')) || 0;
let currentLevel = 'earth', gameActive = false, isPaused = false;
let comboTimeout;
let levelTransition = false;
let levelTransitionTime = 0;

// Configurações personalizadas
let userSettings = {
  balloonColor: '#000000', // Cor padrão preta
  backgroundColor: '#1a1a2e',
  volume: 0.5
};

// Carregar configurações salvas
function loadSettings() {
  const savedSettings = localStorage.getItem('gameSettings');
  if (savedSettings) {
    userSettings = JSON.parse(savedSettings);
    applySettings();
  }
}

// Aplicar configurações
function applySettings() {
  document.body.style.background = userSettings.backgroundColor;
  volumeSlider.value = userSettings.volume;
  document.getElementById('bgMusic').volume = userSettings.volume;
  document.getElementById('popSound').volume = userSettings.volume;
  
  // Atualizar seleção de cores
  document.querySelectorAll('.color-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.color === userSettings.balloonColor || 
        option.dataset.color === userSettings.backgroundColor) {
      option.classList.add('selected');
    }
  });
}

// Salvar configurações
function saveSettings() {
  localStorage.setItem('gameSettings', JSON.stringify(userSettings));
  applySettings();
}

// Limiares para cada nível (atualizados conforme solicitado)
const levelThresholds = { 
  earth: 0, 
  desert: 2000, 
  water: 4000, 
  hell: 20000, 
  space: 40000 
};

// Configurações de spawn para cada nível (reduzidas)
const levelSettings = {
  earth: { spawnChance: 0.03, balloonSpeed: 1.5, balloonSize: 30 },
  desert: { spawnChance: 0.04, balloonSpeed: 2, balloonSize: 25 },
  water: { spawnChance: 0.05, balloonSpeed: 2.5, balloonSize: 35 },
  hell: { spawnChance: 0.06, balloonSpeed: 1.8, balloonSize: 28 },
  space: { spawnChance: 0.07, balloonSpeed: 3, balloonSize: 32 }
};

// Efeitos sonoros
const bgMusic = document.getElementById('bgMusic');
const popSound = document.getElementById('popSound');

// Inicializar estrelas para o fundo
function initStars() {
  stars = [];
  for (let i = 0; i < 200; i++) {
    stars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: Math.random() * 1.5,
      opacity: Math.random()
    });
  }
}

// Desenhar estrelas
function drawStars() {
  ctx.fillStyle = 'white';
  stars.forEach(star => {
    ctx.globalAlpha = star.opacity;
    ctx.fillRect(star.x, star.y, star.size, star.size);
    ctx.globalAlpha = 1;
  });
}

// Event Listeners para navegação
playBtn.addEventListener('click', () => {
  mainMenu.style.display = 'none';
  gameStartScreen.style.display = 'flex';
});

howToPlayBtn.addEventListener('click', () => {
  mainMenu.style.display = 'none';
  howToPlayScreen.style.display = 'flex';
});

backToMenuBtn.addEventListener('click', () => {
  howToPlayScreen.style.display = 'none';
  mainMenu.style.display = 'flex';
});

settingsIcon.addEventListener('click', () => {
  mainMenu.style.display = 'none';
  settingsScreen.style.display = 'flex';
});

document.getElementById('closeSettingsBtn').addEventListener('click', () => {
  settingsScreen.style.display = 'none';
  mainMenu.style.display = 'flex';
});

document.getElementById('saveSettingsBtn').addEventListener('click', () => {
  saveSettings();
  settingsScreen.style.display = 'none';
  mainMenu.style.display = 'flex';
});

// Configurações de cores (atualizadas para preto, azul, amarelo e vermelho)
document.querySelectorAll('#balloonColors .color-option').forEach(option => {
  option.addEventListener('click', () => {
    document.querySelectorAll('#balloonColors .color-option').forEach(opt => {
      opt.classList.remove('selected');
    });
    option.classList.add('selected');
    userSettings.balloonColor = option.dataset.color;
  });
});

document.querySelectorAll('#bgColors .color-option').forEach(option => {
  option.addEventListener('click', () => {
    document.querySelectorAll('#bgColors .color-option').forEach(opt => {
      opt.classList.remove('selected');
    });
    option.classList.add('selected');
    userSettings.backgroundColor = option.dataset.color;
  });
});

// Controle de volume
volumeSlider.addEventListener('input', (e) => {
  userSettings.volume = parseFloat(e.target.value);
  bgMusic.volume = userSettings.volume;
  popSound.volume = userSettings.volume;
});

// Função para iniciar o jogo
function startGame() {
  gameStartScreen.style.display = 'none';
  initStars();
  
  // Aplicar configurações
  document.body.style.background = userSettings.backgroundColor;
  
  // Tentar reproduzir música
  bgMusic.volume = userSettings.volume;
  popSound.volume = userSettings.volume;
  
  const playPromise = bgMusic.play();
  
  if (playPromise !== undefined) {
    playPromise.catch(() => {
      document.addEventListener('click', () => bgMusic.play(), { once: true });
    });
  }
  
  gameActive = true;
  requestAnimationFrame(gameLoop);
}

// Função principal do jogo
function gameLoop(timestamp) {
  if (!gameActive || isPaused) return;

  // Limpar canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Desenhar fundo e efeitos
  drawBackground();
  drawEffects();
  
  // Atualizar HUD
  updateHUD();
  
  // Verificar e atualizar nível
  checkLevel();
  
  // Spawn e atualização de balões
  updateBalloons();
  
  // Desenhar partículas de combo
  drawComboParticles();
  
  // Desenhar efeitos de pontuação
  drawScoreEffects();
  
  // Continuar o loop
  requestAnimationFrame(gameLoop);
}

// Desenhar fundo baseado no nível
function drawBackground() {
  // Fundo de estrelas para espaço
  if (currentLevel === 'space') {
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawStars();
  }
}

// Desenhar efeitos específicos de cada nível
function drawEffects() {
  switch(currentLevel) {
    case 'space':
      drawMeteors();
      break;
    case 'hell':
      drawLava();
      break;
    case 'water':
      drawWaterBubbles();
      break;
    case 'desert':
      drawSand();
      break;
    case 'earth':
      drawClouds();
      drawRain();
      break;
  }
}

// Atualizar HUD
function updateHUD() {
  scoreDisplay.textContent = Math.floor(score);
  livesDisplay.textContent = lives;
  highscoreDisplay.textContent = highscore;
  comboText.textContent = `Combo: ${combo}x`;
}

// Verificar e atualizar nível
function checkLevel() {
  const newLevel = 
    score >= levelThresholds.space ? 'space' :
    score >= levelThresholds.hell ? 'hell' :
    score >= levelThresholds.water ? 'water' :
    score >= levelThresholds.desert ? 'desert' : 'earth';

  if (newLevel !== currentLevel && !levelTransition) {
    levelTransition = true;
    levelTransitionTime = Date.now();
    currentLevel = newLevel;
    
    // Atualizar indicador de nível
    const levelNames = {
      earth: 'Terra',
      desert: 'Deserto',
      water: 'Oceano',
      hell: 'Inferno',
      space: 'Espaço'
    };
    levelIndicator.textContent = `Nível: ${levelNames[currentLevel]}`;
    
    // Efeito visual de transição
    document.body.style.background = getLevelBackground(currentLevel);
    
    // Efeito visual especial na transição
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Resetar transição após 300ms
    setTimeout(() => {
      levelTransition = false;
    }, 300);
  }
}

// Obter fundo para o nível atual
function getLevelBackground(level) {
  const bgMap = {
    earth: userSettings.backgroundColor,
    desert: 'radial-gradient(ellipse at center, #D2691E 0%, #F4A460 100%)',
    water: 'radial-gradient(ellipse at center, #00008B 0%, #1E90FF 100%)',
    hell: 'radial-gradient(ellipse at center, #8B0000 0%, #FF4500 100%)',
    space: 'radial-gradient(ellipse at center, #000428 0%, #004e92 100%)'
  };
  return bgMap[level];
}

// Atualizar balões
function updateBalloons() {
  // Spawn de novos balões
  if (Math.random() < levelSettings[currentLevel].spawnChance) {
    spawnBalloon();
  }

  // Atualizar e desenhar balões existentes (agora caindo)
  balloons.forEach((b, i) => {
    b.y += b.speed; // Alterado para fazer os balões caírem
    drawBalloon(b);
    
    // Verificar se o balão saiu pela parte de baixo da tela
    if (b.y - b.r > canvas.height) {
      balloons.splice(i, 1);
      loseLife();
    }
  });
}

// Spawn de um novo balão
function spawnBalloon() {
  const settings = levelSettings[currentLevel];
  const size = settings.balloonSize + Math.random() * 20;
  
  balloons.push({
    x: Math.random() * canvas.width,
    y: -size, // Começa acima da tela
    r: size,
    color: getBalloonColor(),
    speed: settings.balloonSpeed + Math.random() * 1.5
  });
}

// Perder uma vida
function loseLife() {
  lives--;
  combo = 0;
  
  if (lives <= 0) {
    showGameOver();
  }
}

// Obter cor do balão baseado nas configurações do usuário
function getBalloonColor() {
  // Se for o nível inferno, usar cores quentes
  if (currentLevel === 'hell') {
    return `hsl(${Math.random() * 30 + 10}, 100%, 60%)`;
  }
  
  // Usar a cor selecionada pelo usuário sem variações (cores sólidas)
  return userSettings.balloonColor;
}

// Desenhar balão
function drawBalloon(b) {
  // Sombra
  ctx.beginPath();
  ctx.ellipse(b.x, b.y + b.r * 0.2, b.r * 0.8, b.r * 0.2, 0, 0, Math.PI * 2);
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.fill();
  
  // Balão principal
  ctx.beginPath();
  ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
  
  // Gradiente para dar profundidade
  const gradient = ctx.createRadialGradient(
    b.x - b.r * 0.3, b.y - b.r * 0.3, b.r * 0.1,
    b.x, b.y, b.r
  );
  gradient.addColorStop(0, lightenColor(b.color, 20));
  gradient.addColorStop(1, darkenColor(b.color, 10));
  
  ctx.fillStyle = gradient;
  ctx.fill();
  
  // Reflexo
  ctx.beginPath();
  ctx.arc(b.x - b.r * 0.3, b.y - b.r * 0.3, b.r * 0.2, 0, Math.PI * 2);
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.fill();
  
  // Corda do balão (se estiver perto do topo)
  if (b.y > b.r * 2) {
    ctx.beginPath();
    ctx.moveTo(b.x, b.y + b.r);
    ctx.lineTo(b.x, b.y + b.r * 1.5);
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.lineWidth = 1;
    ctx.stroke();
  }
}

// Funções auxiliares para manipulação de cores
function lightenColor(color, percent) {
  const num = parseInt(color.replace('#', ''), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) + amt;
  const G = (num >> 8 & 0x00FF) + amt;
  const B = (num & 0x0000FF) + amt;
  return `#${(
    0x1000000 +
    (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
    (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
    (B < 255 ? (B < 1 ? 0 : B) : 255)
  ).toString(16).slice(1)}`;
}

function darkenColor(color, percent) {
  const num = parseInt(color.replace('#', ''), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) - amt;
  const G = (num >> 8 & 0x00FF) - amt;
  const B = (num & 0x0000FF) - amt;
  return `#${(
    0x1000000 +
    (R > 0 ? (R < 255 ? R : 255) : 0) * 0x10000 +
    (G > 0 ? (G < 255 ? G : 255) : 0) * 0x100 +
    (B > 0 ? (B < 255 ? B : 255) : 0)
  ).toString(16).slice(1)}`;
}

// Efeitos específicos de cada nível
function drawMeteors() {
  // Atualizar e desenhar meteoros
  meteors.forEach((m, i) => {
    // Cauda do meteoro
    ctx.beginPath();
    ctx.moveTo(m.x, m.y);
    ctx.lineTo(m.x - m.vx * 5, m.y - m.vy * 5);
    ctx.strokeStyle = `rgba(255,165,0,${m.opacity})`;
    ctx.lineWidth = m.size / 2;
    ctx.stroke();
    
    // Corpo do meteoro
    ctx.beginPath();
    ctx.arc(m.x, m.y, m.size, 0, Math.PI * 2);
    ctx.fillStyle = m.color;
    ctx.fill();
    
    // Atualizar posição
    m.x += m.vx;
    m.y += m.vy;
    m.opacity *= 0.98;
    
    // Remover se sair da tela ou ficar muito transparente
    if (m.y > canvas.height || m.opacity < 0.1) {
      meteors.splice(i, 1);
    }
  });

  // Spawn de novos meteoros
  if (Math.random() < 0.02) {
    meteors.push({
      x: Math.random() * canvas.width,
      y: -20,
      size: 3 + Math.random() * 4,
      color: `hsl(${Math.random() * 30 + 20}, 100%, 50%)`,
      vx: (Math.random() - 0.5) * 2,
      vy: 6 + Math.random() * 3,
      opacity: 1
    });
  }
}

function drawLava() {
  // Atualizar e desenhar bolhas de lava
  lavaBubbles.forEach((b, i) => {
    // Gradiente para efeito de brilho
    const g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.size);
    g.addColorStop(0, `rgba(255,${140 + Math.sin(Date.now()/200) * 50},0,0.7)`);
    g.addColorStop(1, 'rgba(255,0,0,0.3)');
    
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
    ctx.fill();

    // Atualizar posição e tamanho
    b.y -= b.speed;
    b.size *= 0.99;
    
    // Remover se ficar muito pequeno ou sair da tela
    if (b.y < -b.size || b.size < 2) {
      lavaBubbles.splice(i, 1);
    }
  });

  // Spawn de novas bolhas de lava
  if (Math.random() < 0.08) {
    lavaBubbles.push({
      x: Math.random() * canvas.width,
      y: canvas.height + 20,
      size: 8 + Math.random() * 12,
      speed: 1 + Math.random() * 2
    });
  }
}

function drawWaterBubbles() {
  // Atualizar e desenhar bolhas de água
  waterBubbles.forEach((b, i) => {
    // Gradiente para efeito de transparência
    const g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
    g.addColorStop(0, 'rgba(173,216,230,0.6)');
    g.addColorStop(1, 'rgba(70,130,180,0.3)');
    
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
    ctx.fill();

    // Movimento ondulado
    b.x += Math.sin(Date.now() / 500 + i) * 0.5;
    b.y -= b.speed;
    
    // Remover se sair da tela
    if (b.y < -b.r) {
      waterBubbles.splice(i, 1);
    }
  });

  // Spawn de novas bolhas de água
  if (Math.random() < 0.1) {
    waterBubbles.push({
      x: Math.random() * canvas.width,
      y: canvas.height + 20,
      r: 5 + Math.random() * 10,
      speed: 1 + Math.random() * 2
    });
  }
}

function drawSand() {
  // Atualizar e desenhar partículas de areia
  sandParticles.forEach((p, i) => {
    ctx.fillStyle = `rgba(210,180,140,${p.opacity})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();

    // Movimento com padrão de vento
    p.x += p.speed;
    p.y += Math.sin(Date.now() / 1000 + i) * 0.5;
    
    // Remover se sair da tela
    if (p.x > canvas.width + p.size) {
      sandParticles.splice(i, 1);
    }
  });

  // Spawn de novas partículas de areia
  if (Math.random() < 0.2) {
    sandParticles.push({
      x: -10,
      y: Math.random() * canvas.height,
      size: 1 + Math.random() * 3,
      speed: 0.5 + Math.random() * 1,
      opacity: 0.3 + Math.random() * 0.4
    });
  }
}

function spawnClouds() {
  clouds.push({
    x: -100,
    y: Math.random() * canvas.height * 0.4,
    w: 100 + Math.random() * 100,
    h: 50 + Math.random() * 30,
    speed: 0.3 + Math.random() * 0.2,
    opacity: 0.6 + Math.random() * 0.3
  });
}

function drawClouds() {
  // Atualizar e desenhar nuvens
  clouds.forEach((cloud, i) => {
    ctx.fillStyle = `rgba(255,255,255,${cloud.opacity})`;
    ctx.beginPath();
    ctx.ellipse(cloud.x, cloud.y, cloud.w, cloud.h, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Movimento das nuvens
    cloud.x += cloud.speed;
    
    // Remover se sair da tela
    if (cloud.x > canvas.width + 150) {
      clouds.splice(i, 1);
    }
  });

  // Spawn de novas nuvens
  if (Math.random() < 0.01) {
    spawnClouds();
  }
}

function drawRain() {
  // Atualizar e desenhar gotas de chuva
  raindrops.forEach((drop, i) => {
    ctx.strokeStyle = `rgba(174,194,224,${drop.opacity})`;
    ctx.lineWidth = drop.w;
    ctx.beginPath();
    ctx.moveTo(drop.x, drop.y);
    ctx.lineTo(drop.x + drop.len * 0.3, drop.y + drop.len);
    ctx.stroke();
    
    // Movimento das gotas
    drop.y += drop.speed;
    drop.x += drop.speed * 0.3;
    
    // Remover se sair da tela
    if (drop.y > canvas.height) {
      raindrops.splice(i, 1);
    }
  });

  // Spawn de novas gotas de chuva
  if (Math.random() < 0.2) {
    raindrops.push({
      x: Math.random() * canvas.width,
      y: -10,
      len: 10 + Math.random() * 10,
      speed: 4 + Math.random() * 2,
      w: 1 + Math.random() * 1,
      opacity: 0.4 + Math.random() * 0.3
    });
  }
}

// Partículas de efeito de combo
function drawComboParticles() {
  comboParticles.forEach((p, i) => {
    ctx.fillStyle = `rgba(${p.r},${p.g},${p.b},${p.a})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();

    // Física das partículas
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.05; // Gravidade
    p.a -= 0.02;  // Fade out
    
    // Remover quando ficar transparente
    if (p.a <= 0) {
      comboParticles.splice(i, 1);
    }
  });
}

// Efeitos de pontuação (+10, +20, etc)
function drawScoreEffects() {
  scoreEffects.forEach((effect, i) => {
    ctx.font = `${effect.size}px Arial`;
    ctx.fillStyle = effect.color;
    ctx.textAlign = 'center';
    ctx.fillText(effect.text, effect.x, effect.y);
    
    // Atualizar posição e tamanho
    effect.y -= effect.speed;
    effect.size *= 0.98;
    effect.opacity -= 0.02;
    effect.color = `rgba(76, 201, 240, ${effect.opacity})`;
    
    // Remover quando ficar transparente
    if (effect.opacity <= 0) {
      scoreEffects.splice(i, 1);
    }
  });
}

// Criar partículas de combo
function spawnComboParticles(x, y, count = 15) {
  for (let i = 0; i < count; i++) {
    comboParticles.push({
      x, y,
      size: 2 + Math.random() * 4,
      vx: (Math.random() - 0.5) * 5,
      vy: (Math.random() - 0.5) * 5 - 2,
      r: 255,
      g: 255 - combo * 10,
      b: 50 + combo * 5,
      a: 0.8
    });
  }
}

// Criar efeito de pontuação
function spawnScoreEffect(x, y, points) {
  scoreEffects.push({
    x, y,
    text: `+${points}`,
    size: 24,
    color: 'rgba(76, 201, 240, 1)',
    opacity: 1,
    speed: 1
  });
}

// Atualizar sistema de combo
function updateCombo() {
  const now = Date.now();
  
  // Resetar combo se passar muito tempo entre cliques
  if (now - lastClickTime > 1000) {
    combo = 0;
  } else {
    combo++;
    
    // Bônus visual e de pontos para combos altos
    if (combo % 5 === 0) {
      score += combo * 2;
      spawnComboParticles(canvas.width / 2, 100, 30);
    }
  }
  
  lastClickTime = now;

  // Resetar combo após 1 segundo sem cliques
  clearTimeout(comboTimeout);
  comboTimeout = setTimeout(() => {
    combo = 0;
    document.getElementById('comboFill').style.width = '0%';
    document.getElementById('comboFill').style.background = 'linear-gradient(90deg, #ffdd00, #ff0080)';
  }, 1000);

  // Atualizar barra de combo
  const comboFill = document.getElementById('comboFill');
  const maxCombo = 20;
  const comboPercent = Math.min((combo / maxCombo) * 100, 100);
  comboFill.style.width = comboPercent + '%';

  // Mudar cor da barra conforme o combo aumenta
  if (combo >= 5) comboFill.style.background = 'linear-gradient(90deg, #00ffcc, #0099ff)';
  if (combo >= 10) comboFill.style.background = 'linear-gradient(90deg, #ff00cc, #ff0000)';
  if (combo >= 15) comboFill.style.background = 'linear-gradient(90deg, #ffff00, #ff6600)';
}

// Salvar pontuação no Firebase
function saveHighScore(score) {
  const scoresRef = database.ref('highscores');
  const newScoreRef = scoresRef.push();
  newScoreRef.set({
    score: score,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
}

// Tela de game over
function showGameOver() {
  gameActive = false;
  gameOverScreen.style.display = 'flex';

  // Verificar se bateu o recorde
  const isNewHighscore = score > highscore;
  if (isNewHighscore) {
    highscore = score;
    localStorage.setItem('highscore', highscore);
    newRecordDisplay.style.display = 'block';
    // Salvar no Firebase apenas se for um novo recorde
    saveHighScore(score);
  } else {
    newRecordDisplay.style.display = 'none';
  }

  // Atualizar informações na tela de game over
  finalScoreDisplay.textContent = 'Pontuação: ' + Math.floor(score);
  
  const levelNames = {
    earth: 'Terra',
    desert: 'Deserto',
    water: 'Oceano',
    hell: 'Inferno',
    space: 'Espaço'
  };
  finalLevelDisplay.textContent = 'Nível alcançado: ' + levelNames[currentLevel];
}

// Pausar/continuar o jogo
function togglePause() {
  isPaused = !isPaused;
  
  if (isPaused) {
    pauseScreen.style.display = 'flex';
    document.getElementById('pauseBtn').textContent = '▶ Continuar';
    bgMusic.pause();
  } else {
    pauseScreen.style.display = 'none';
    document.getElementById('pauseBtn').textContent = '⏸️ Pausar';
    bgMusic.play();
    requestAnimationFrame(gameLoop);
  }
}

// Reiniciar o jogo
function restartGame() {
  // Resetar variáveis do jogo
  score = 0; 
  lives = 5; 
  combo = 0;
  balloons = []; 
  meteors = []; 
  lavaBubbles = [];
  waterBubbles = []; 
  sandParticles = [];
  clouds = []; 
  raindrops = []; 
  comboParticles = [];
  scoreEffects = [];
  currentLevel = 'earth'; 
  isPaused = false;
  gameActive = true;
  
  // Resetar interface
  document.getElementById('pauseBtn').textContent = '⏸️ Pausar';
  gameOverScreen.style.display = 'none';
  pauseScreen.style.display = 'none';
  document.getElementById('comboFill').style.width = '0%';
  document.body.style.background = getLevelBackground('earth');
  levelIndicator.textContent = 'Nível: Terra';
  
  // Reiniciar música
  bgMusic.currentTime = 0;
  bgMusic.play();
  
  // Iniciar loop do jogo
  requestAnimationFrame(gameLoop);
}

// Voltar ao menu principal
function returnToMenu() {
  // Parar o jogo
  gameActive = false;
  isPaused = false;
  
  // Resetar variáveis do jogo
  score = 0;
  lives = 5;
  combo = 0;
  balloons = [];
  meteors = [];
  lavaBubbles = [];
  waterBubbles = [];
  sandParticles = [];
  clouds = [];
  raindrops = [];
  comboParticles = [];
  scoreEffects = [];
  currentLevel = 'earth';
  
  // Esconder todas as telas do jogo
  gameStartScreen.style.display = 'none';
  gameOverScreen.style.display = 'none';
  pauseScreen.style.display = 'none';
  
  // Mostrar menu principal
  mainMenu.style.display = 'flex';
  
  // Pausar música
  bgMusic.pause();
  bgMusic.currentTime = 0;
}

// Event Listeners do jogo
startBtn.addEventListener('click', startGame);

document.getElementById('pauseBtn').addEventListener('click', togglePause);
document.getElementById('resumeBtn').addEventListener('click', togglePause);
document.getElementById('restartBtn').addEventListener('click', restartGame);
document.getElementById('restartBtnPause').addEventListener('click', () => {
  togglePause();
  restartGame();
});
document.getElementById('quitBtn').addEventListener('click', returnToMenu);
document.getElementById('menuBtn').addEventListener('click', returnToMenu);

// Evento de clique no canvas
canvas.addEventListener('click', (e) => {
  if (!gameActive || isPaused) return;
  
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;
  let hit = false;

  // Verificar colisão com balões
  balloons.forEach((b, i) => {
    const dx = clickX - b.x;
    const dy = clickY - b.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    if (distance < b.r) {
      // Balão estourado (acerto)
      balloons.splice(i, 1);
      const pointsEarned = 10 + combo * 2;
      score += pointsEarned;
      updateCombo();
      spawnComboParticles(b.x, b.y);
      spawnScoreEffect(b.x, b.y, pointsEarned);
      
      // Efeito sonoro
      popSound.currentTime = 0;
      popSound.play();
      
      hit = true;
    }
  });

  // Penalidade por errar (não perde vida, só reseta o combo)
  if (!hit) {
    combo = 0;
  }
});

// Redimensionamento da tela
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  initStars(); // Recriar estrelas para o novo tamanho
});

// Prevenir o menu de contexto ao clicar com o botão direito
canvas.addEventListener('contextmenu', (e) => {
  e.preventDefault();
});

// Carregar configurações ao iniciar
loadSettings();
initStars();
</script>
</body>
</html>